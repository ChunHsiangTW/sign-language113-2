<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ‰‹èªè¾¨èª Demoï¼ˆä¿®æ­£ç‰ˆï¼šç›¸æ©Ÿæ¬Šé™èˆ‡ç’°å¢ƒè‡ªæª¢ï¼‰</title>
  <style>
:root {
  --bg: #fff0f6;
  --card: #ffe6f0;
  --text: #2a2a2a;
  --muted: #a18ea1;
  --ok: #36d399;
  --warn: #fbbf24;
  --err: #ef4444;
  --primary: #ff6fa1;
  --secondary: #f7c7d9;
  --btn-text: #fff;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  background: linear-gradient(180deg, #ffe6f0, #fff0f6);
  color: var(--text);
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
}

.wrap {
  max-width: 1200px;
  margin: 24px auto;
  padding: 16px;
}

h1 {
  margin: 0 0 12px 4px;
  font-size: 22px;
  color: var(--primary);
}

.grid {
  display: grid;
  gap: 16px;
  grid-template-columns: 1.2fr .8fr;
}

.card {
  background: var(--card);
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,.15);
  overflow: hidden;
  border: 1px solid #ffd6e6;
}

.card h2 {
  margin: 0;
  padding: 14px 16px;
  border-bottom: 1px solid #ffd6e6;
  font-size: 16px;
  color: var(--primary);
  letter-spacing: .5px;
}

.video-area {
  position: relative;
  aspect-ratio: 16/9;
  background: #000;
  border-radius: 16px;
  overflow: hidden;
}

video, canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  border-radius: 16px;
}

.overlay {
  position: absolute;
  left: 12px;
  bottom: 12px;
  background: rgba(255,255,255,0.3);
  backdrop-filter: blur(6px);
  padding: 10px 12px;
  border-radius: 12px;
  font-size: 14px;
  color: var(--text);
}

.toolbar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  padding: 12px 16px;
}

button, select {
  appearance: none;
  border: 0;
  border-radius: 999px;
  padding: 10px 16px;
  font-weight: 700;
  transition: 0.2s;
}

button {
  cursor: pointer;
  background: var(--primary);
  color: var(--btn-text);
  box-shadow: 0 6px 16px rgba(255,111,161,.35);
}

button.secondary {
  background: var(--secondary);
  color: var(--text);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

select {
  background: #ffe6f0;
  color: var(--text);
  border: 1px solid #ffd6e6;
}

.status {
  font-size: 12px;
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
}

.dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #ea3b3b;
  box-shadow: 0 0 0 0 rgba(234,59,59,.6);
  animation: pulse 1.8s infinite;
}

.dot.on {
  background: var(--ok);
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(234,59,59,.6); }
  70% { box-shadow: 0 0 0 12px rgba(234,59,59,0); }
  100% { box-shadow: 0 0 0 0 rgba(234,59,59,0); }
}

.banner {
  padding: 10px 16px;
  border-bottom: 1px solid #ffd6e6;
  background: #fff0f6;
}

.banner .msg {
  display: flex;
  gap: 10px;
  align-items: flex-start;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 700;
}

.ok { background: rgba(54,211,153,.15); color: var(--ok); border:1px solid rgba(54,211,153,.35); }
.warn { background: rgba(251,191,36,.15); color: var(--warn); border:1px solid rgba(251,191,36,.35); }
.err { background: rgba(239,68,68,.15); color: var(--err); border:1px solid rgba(239,68,68,.35); }

.result {
  padding: 16px;
  line-height: 1.5;
}

.result .label {
  font-size: 36px;
  font-weight: 900;
  color: var(--primary);
}

.muted { color: var(--muted); }

.list {
  padding: 12px 16px;
}

.list li {
  padding: 6px 0;
  border-bottom: 1px dashed #ffd6e6;
}

.kbd {
  font-family: ui-monospace, Menlo, Consolas, monospace;
  background: #ffe6f0;
  border: 1px solid #ffd6e6;
  padding: 0 8px;
  border-radius: 6px;
}

.footer {
  opacity: .7;
  font-size: 12px;
  padding: 8px 16px;
}

.tests {
  padding: 12px 16px;
}

.tests li {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  border-bottom: 1px dashed #ffd6e6;
  padding: 8px 0;
}

.tests small { opacity: .75; }

button, .button {
    background-color: #ff90b3; /* èƒŒæ™¯é¡è‰² */
    color: white; /* æ–‡å­—é¡è‰² */
    padding: 12px 20px; /* å…§é‚Šè· */
    border: none; /* å»é™¤é‚Šæ¡† */
    border-radius: 4px; /* åœ“è§’ */
    font-size: 16px; /* å­—å‹å¤§å° */
    cursor: pointer; /* æ»‘é¼ è®Šç‚ºå¯é»æ“Šæ‰‹å‹ */
    transition: background-color 0.3s; /* èƒŒæ™¯é¡è‰²è®ŠåŒ–éæ¸¡æ•ˆæœ */
    text-align: center; /* æ–‡å­—ç½®ä¸­ */
    display: inline-block; /* è¡Œå…§å€å¡Š */
    margin-top: 20px; /* ä¸Šé‚Šè· */
    margin: center; 
}

/* æŒ‰éˆ•æ‡¸åœæ•ˆæœ */
button:hover, .button:hover {
    background-color: #ff6d9d; /* èƒŒæ™¯é¡è‰² */
}

@media (max-width: 1100px) {
  .grid { grid-template-columns: 1fr; }
}

@media (max-width: 600px) {
  .toolbar { flex-direction: column; align-items: stretch; }
  .video-area { aspect-ratio: 4/3; }
}

  </style>
  <!-- MediaPipe Hands èˆ‡ç¹ªåœ–å·¥å…· -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 12px 4px; font-size:22px">ğŸ–ï¸ åŠæ™‚æ‰‹èªç¿»è­¯</h1>

    <div class="grid">
      <!-- å·¦ï¼šå½±åƒå€ -->
      <div class="card">
        <div class="banner">
          
        </div>
        <h2>é¡é ­ç•«é¢</h2>
        <div class="video-area">
          <video id="video" playsinline muted autoplay></video>
          <canvas id="canvas"></canvas>
          <div class="overlay">
            <div><span class="muted">FPS</span>ï¼š<span id="fps">0</span></div>
            <div><span class="muted">ç‹€æ…‹</span>ï¼š<span id="state">å¾…æ©Ÿ</span></div>
          </div>
        </div>
        <div class="toolbar">
          <button id="btnStart">é–‹å§‹</button>
          <button id="btnStop" class="secondary" disabled>çµæŸ</button>
          <select id="cameraSelect" title="é¸æ“‡ç›¸æ©Ÿ"></select>
          <div class="status"><span class="dot" id="dot"></span><span id="hint">æœªå•Ÿå‹•</span></div>
        </div>
      </div>

      <!-- å³ï¼šçµæœï¼‹æ¸¬è©¦å€ -->
      <div class="card">
        <h2>ç¿»è­¯çµæœ</h2>
        <div class="result">
          <div class="muted">ç›®å‰è¾¨è­˜çš„å–®å­—</div>
          <div class="label" id="label">ï¼ˆç„¡è³‡æ–™ï¼‰</div>
        </div>
        <h2>æ”¯æ´çš„ç¤ºç¯„æ‰‹å‹ â†’ å–®å­—ï¼ˆè¦å‰‡ç‰ˆï¼‰</h2>
        <ul class="list">
          <li>âœŠ æ‹³é ­ï¼ˆ0æŒ‡ï¼‰â†’ <b>å¥½</b></li>
          <li>ğŸ–ï¸ å…©æ‰‹äº”æŒ‡å¼µé–‹ï¼ˆ5æŒ‡ï¼‰â†’ <b>å®¶</b></li>
          <li>âœŒï¸ å¤§æ‹‡æŒ‡è·Ÿé£ŸæŒ‡ï¼ˆ2æŒ‡ï¼‰â†’ <b>ä¸Š</b></li>
          <li>   é™¤äº†å¤§æ‹‡æŒ‡è·Ÿå°æ‹‡æŒ‡ï¼ˆ3æŒ‡ï¼‰â†’ <b>ä¸‰</b></li>
          <li>ğŸ‘ å¤§æ‹‡æŒ‡ï¼ˆ1æ‹‡æŒ‡ï¼‰â†’ <b>æ£’</b></li>
          <li>ğŸ‘ é£ŸæŒ‡ï¼ˆ1æ‹‡æŒ‡ï¼‰â†’ <b>æ‰‹æ©Ÿ</b></li>
        </ul>
        
        <ul id="tests" class="tests">
          <!-- ç”±ç¨‹å¼å‹•æ…‹å¡«å…¥æ¸¬è©¦çµæœ -->
        </ul>
             </div>
    </div>
  </div>

  <script>
    // ====== DOM åƒç…§ ======
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnDiag = document.getElementById('btnDiag');
    const cameraSelect = document.getElementById('cameraSelect');
    const labelEl = document.getElementById('label');
    const dot = document.getElementById('dot');
    const hint = document.getElementById('hint');
    const fpsEl = document.getElementById('fps');
    const stateEl = document.getElementById('state');
    const testsEl = document.getElementById('tests');
    const secureBadge = document.getElementById('secureBadge');
    const envMsg = document.getElementById('envMsg');

    // ====== ç‹€æ…‹ ======
    let stream = null;      // MediaStream
    let running = false;    // æ˜¯å¦åŸ·è¡Œä¸­
    let rafId = null;       // requestAnimationFrame id
    let lastTime = performance.now();

    // ====== MediaPipe Hands åˆå§‹åŒ– ======
    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    // ====== å·¥å…·ï¼šç’°å¢ƒæª¢æŸ¥ ======
    const isLocalhost = ['localhost','127.0.0.1','[::1]'].includes(location.hostname);
    const isSecure = window.isSecureContext || location.protocol === 'https:';

    function updateSecureBadge(){
      if (isSecure || isLocalhost){
        secureBadge.className = 'badge ok';
        secureBadge.textContent = 'å®‰å…¨ï¼šå¯ä½¿ç”¨ç›¸æ©Ÿ';
        envMsg.innerHTML = 'ç›®å‰ä½æ–¼ <b>'+(isSecure? 'HTTPS':'localhost')+'</b>ï¼Œå¯ä»¥è¦æ±‚ç›¸æ©Ÿæ¬Šé™ã€‚';
        btnStart.disabled = false;
      }else{
        secureBadge.className = 'badge err';
        secureBadge.textContent = 'ä¸å®‰å…¨ï¼šå¯èƒ½è¢«æ“‹';
        envMsg.innerHTML = 'è«‹æ”¹ç”¨ <b>HTTPS</b> æˆ– <b>http://localhost</b>ï¼ˆä¾‹å¦‚ VS Code Live Serverã€æˆ– <span class="kbd">python -m http.server</span> å¾Œç”¨ <b>localhost</b> å­˜å–ï¼‰ã€‚';
        btnStart.disabled = true;
      }
    }

    // ====== æ¸¬è©¦æ¡ˆä¾‹ï¼ˆé¡¯ç¤ºæ–¼å³å´ï¼‰ ======
    function addTest(name, ok, info=''){
      const li = document.createElement('li');
      const badge = `<span class="badge ${ok? 'ok':'err'}">${ok? 'PASS':'FAIL'}</span>`;
      li.innerHTML = `<span>${name} ${info? '<small>â€” '+info+'</small>':''}</span>${badge}`;
      testsEl.appendChild(li);
    }

    async function runDiagnostics(){
      testsEl.innerHTML = '';
      addTest('Secure Context / localhost', (isSecure || isLocalhost), (isSecure? 'HTTPS':'host='+location.host));

      const hasMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      addTest('navigator.mediaDevices å­˜åœ¨', hasMedia);
      if (!hasMedia) return;

      // å˜—è©¦è®€å–æ¬Šé™ç‹€æ…‹ï¼ˆéƒ¨åˆ†ç€è¦½å™¨ä¸æ”¯æ´ camera æ¬Šé™åï¼‰
      let perm = 'unknown';
      try{
        // æœ‰äº›ç€è¦½å™¨æ¬Šé™åæ˜¯ 'camera'ï¼Œæœ‰äº›ä¸æ”¯æ´ï¼Œæ•… try/catch åŒ…ä½
        const pres = await navigator.permissions.query({name: 'camera'});
        perm = pres.state;
      }catch{ perm = 'unavailable'; }
      addTest('æ¬Šé™ API ç‹€æ…‹', perm !== 'denied', 'state='+perm);

      // åˆ—å‡ºè£ç½®
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==='videoinput');
        addTest('å¯ç”¨ç›¸æ©Ÿæ•¸é‡', cams.length>0, 'count='+cams.length);
      }catch(err){
        addTest('åˆ—å‡ºè£ç½® enumerateDevices()', false, err.name);
      }
    }

    // ====== å–å¾—å¯ç”¨ç›¸æ©Ÿä¸¦å¡«å…¥ä¸‹æ‹‰é¸å–® ======
    async function populateCameras(){
      if (!navigator.mediaDevices?.enumerateDevices) return;
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      cameraSelect.innerHTML = '';
      cams.forEach((cam, i)=>{
        const opt = document.createElement('option');
        opt.value = cam.deviceId;
        opt.textContent = cam.label || `Camera ${i+1}`;
        cameraSelect.appendChild(opt);
      });
      if (cams.length===0){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®';
        cameraSelect.appendChild(opt);
      }
    }

    // ====== é–‹å§‹ï¼åœæ­¢ ======
    async function start(){
      if (running) return;

      // 1) å…ˆç¢ºèªç’°å¢ƒ
      if (!(isSecure || isLocalhost)){
        alert('ç›®å‰é HTTPS/localhostï¼Œç€è¦½å™¨å°‡é˜»æ“‹ç›¸æ©Ÿã€‚\nè«‹ä»¥ HTTPS æˆ– http://localhost é–‹å•Ÿå¾Œå†è©¦ã€‚');
        return;
      }

      // 2) å…ˆä»¥ getUserMedia ä¸»å‹•è¦æ±‚æˆæ¬Šï¼ˆä¸¦å¯æŒ‡å®šè£ç½®ï¼‰
      let constraints = { video: { width: {ideal: 1280}, height: {ideal: 720} } };
      const devId = cameraSelect.value;
      if (devId) constraints.video.deviceId = { exact: devId };
      else constraints.video.facingMode = 'user';

      try{
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      }catch(e){
        handleGetUserMediaError(e);
        return;
      }

      // 3) å°‡ä¸²æµç¹«çµåˆ° <video> ä¸¦å•Ÿå‹•è¾¨è­˜è¿´åœˆ
      try{
        video.srcObject = stream;
        await video.play();
      }catch(e){
        alert('ç„¡æ³•æ’­æ”¾ç›¸æ©Ÿä¸²æµï¼š'+e.message);
        stop();
        return;
      }

      // æ›´æ–° UI ç‹€æ…‹
      running = true;
      btnStart.disabled = true;
      btnStop.disabled = false;
      dot.classList.add('on');
      hint.textContent = 'åµæ¸¬ä¸­';
      stateEl.textContent = 'åŸ·è¡Œä¸­';

      // å•Ÿå‹•å½±åƒè¿´åœˆï¼šæ¯å¹€é€é€² MediaPipe
      lastTime = performance.now();
      loop();

      // å–å¾—æˆæ¬Šå¾Œï¼Œå†æ¬¡å¡«å…¥ç›¸æ©Ÿåˆ—è¡¨ï¼ˆæ­¤æ™‚å¯è®€ labelï¼‰
      populateCameras();
    }

    function stop(){
      running = false;
      btnStart.disabled = false;
      btnStop.disabled = true;
      dot.classList.remove('on');
      hint.textContent = 'æœªå•Ÿå‹•';
      stateEl.textContent = 'å¾…æ©Ÿ';
      labelEl.textContent = 'ï¼ˆç„¡è³‡æ–™ï¼‰';
      if (rafId) cancelAnimationFrame(rafId);
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      const w = canvas.width, h = canvas.height; ctx.clearRect(0,0,w,h);
    }

    async function loop(){
      if (!running) return;
      try{
        await hands.send({ image: video });
      }catch(e){
        console.warn('hands.send error:', e);
      }
      // FPS
      const now = performance.now();
      const dt = now - lastTime; lastTime = now; fpsEl.textContent = Math.max(1, Math.round(1000/dt));
      rafId = requestAnimationFrame(loop);
    }

    // ====== MediaPipe çµæœå›å‘¼ ======
    function onResults(results){
      if (!running) return;
      // ç•«é¢å°ºå¯¸
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // ç•«å‡ºå½±åƒ
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      // ç•«é—œéµé»
      if (results.multiHandLandmarks && results.multiHandLandmarks.length){
        for (const landmarks of results.multiHandLandmarks){
          drawConnectors(ctx, landmarks, HAND_CONNECTIONS, { lineWidth: 3 });
          drawLandmarks(ctx, landmarks, { lineWidth: 1, radius: 3 });
        }
      }
      ctx.restore();

      // ç¿»è­¯ï¼ˆè¦å‰‡ç‰ˆï¼‰
      const word = classifyGesture(results.multiHandLandmarks);
      labelEl.textContent = word;
    }

    // ====== ç°¡å–®è¦å‰‡åˆ†é¡å™¨ ======
    function classifyGesture(landmarks){
      if (!landmarks || landmarks.length===0) return 'ï¼ˆç„¡è³‡æ–™ï¼‰';
      const pts = landmarks[0]; // å–ç¬¬ä¸€éš»æ‰‹
      const isFingerUp = (tip,pip)=> pts[tip].y < pts[pip].y; // y è¶Šå°è¶Šé«˜
      const isThumbUp = ()=>{ const tip=pts[4], base=pts[2]; const dx=tip.x-base.x, dy=tip.y-base.y; return Math.hypot(dx,dy)>0.08 };
      const fingers = { thumb:isThumbUp(), index:isFingerUp(8,6), middle:isFingerUp(12,10), ring:isFingerUp(16,14), pinky:isFingerUp(20,18) };
      const up = Object.values(fingers).filter(Boolean).length;
      if (up===0) return 'å¥½';
      if (up===5) return 'å®¶';
      if (fingers.index && fingers.thumb && !fingers.ring && !fingers.pinky && !fingers.middle) return 'ä¸Š';
      if (fingers.index && fingers.middle && fingers.ring && !fingers.pinky && !fingers.thumb) return 'ä¸‰';
      if (fingers.thumb && !fingers.middle && !fingers.index && !fingers.ring && !fingers.pinky) return 'æ£’';
      if (fingers.index && !fingers.middle && !fingers.thumb && !fingers.ring && !fingers.pinky) return 'æ‰‹æ©Ÿ';
      return 'ï¼ˆåµæ¸¬ä¸­â€¦ï¼‰';
    }
   

    // ====== å‹å–„éŒ¯èª¤è™•ç† ======
    function handleGetUserMediaError(e){
      console.error('getUserMedia error:', e);
      let msg = '';
      switch(e.name){
        case 'NotAllowedError':
        case 'SecurityError':
          msg = 'æ¬Šé™è¢«æ‹’ï¼šè«‹æŒ‰ç¶²å€åˆ—å·¦é‚Šçš„é–é ­ â†’ å…è¨±ç›¸æ©Ÿï¼›æˆ–åœ¨ç€è¦½å™¨è¨­å®š > éš±ç§æ¬Šèˆ‡å®‰å…¨æ€§ > ç¶²ç«™è¨­å®š > ç›¸æ©Ÿ ä¸­è§£é™¤å°é–ã€‚';
          break;
        case 'NotFoundError':
        case 'DevicesNotFoundError':
          msg = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿï¼šè«‹ç¢ºèªç›¸æ©Ÿå·²é€£æ¥æˆ–æœªè¢«å…¶ä»–è»Ÿé«”å ç”¨ã€‚';
          break;
        case 'NotReadableError':
        case 'TrackStartError':
          msg = 'ç›¸æ©Ÿè¢«å ç”¨æˆ–ç„¡æ³•å­˜å–ï¼šè«‹é—œé–‰å…¶ä»–ä½¿ç”¨ç›¸æ©Ÿçš„æ‡‰ç”¨ç¨‹å¼ï¼ˆä¾‹å¦‚æœƒè­°è»Ÿé«”ï¼‰ã€‚';
          break;
        case 'OverconstrainedError':
          msg = 'ç„¡æ³•æ»¿è¶³ç›¸æ©Ÿé™åˆ¶ï¼ˆè§£æåº¦/è£ç½®IDï¼‰ï¼Œè«‹æ”¹ç”¨é è¨­è¨­å®šæˆ–åˆ‡æ›ç›¸æ©Ÿã€‚';
          break;
        default:
          msg = 'é–‹å•Ÿç›¸æ©Ÿå¤±æ•—ï¼š'+(e.message||e.name);
      }
      alert(msg);
      // UI å¾©åŸ
      stop();
    }

    // ====== ç¶å®šäº‹ä»¶ ======
    btnStart.addEventListener('click', start);
    btnStop.addEventListener('click', stop);
    btnDiag.addEventListener('click', runDiagnostics);

    // åˆ‡æ›ç›¸æ©Ÿæ™‚ï¼Œè‹¥æ­£åœ¨åŸ·è¡Œå‰‡é‡å•Ÿä¸²æµ
    cameraSelect.addEventListener('change', async ()=>{ if (running){ stop(); start(); } });

    // ====== åˆå§‹åŒ– ======
    (async function init(){
      updateSecureBadge();
      await populateCameras();
      await runDiagnostics();
    })();
  </script>
</body>
</html>
<div style="display:flex; justify-content:center; margin-top:20px;">
  <a href="{{ url_for('index') }}" class="button">å›é¦–é </a>
</div>

